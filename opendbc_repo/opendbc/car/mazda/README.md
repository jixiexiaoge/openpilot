# Mazda车型OpenPilot优化

本项目基于社区开发的`mzdaCSLC`代码，对Mazda车型在OpenPilot中的支持进行了优化，特别是添加了自动控制车速(CSLC)功能。

## 主要功能

1. **自动控制车速(CSLC)**：通过模拟按下巡航控制按钮来实现对车速的精确控制，使车辆能够自动跟随设定的目标速度。
2. **优化的纵向控制参数**：针对Mazda车型特性调整的PID控制参数，提供更平稳的加减速体验。
3. **实验模式**：提供基于当前车速和加速度动态计算目标速度的实验功能。

## 安装和配置

1. 将代码文件复制到OpenPilot对应目录
2. 设置以下参数：
   - `CSLCEnabled`: 设置为`1`启用CSLC功能
   - `IsMetric`: 设置为`1`使用公制单位(km/h)，设置为`0`使用英制单位(mph)
   - `ExperimentalMode`: 设置为`1`启用实验模式
   - `CSLCSpeed`: 设置目标速度(m/s)

可以通过SSH连接到设备，使用以下命令设置参数：
```bash
# 启用CSLC功能
echo "1" > /data/params/d/CSLCEnabled

# 设置目标速度(例如25m/s，约90km/h)
echo "25" > /data/params/d/CSLCSpeed

# 使用公制单位
echo "1" > /data/params/d/IsMetric

# 启用实验模式
echo "1" > /data/params/d/ExperimentalMode
```

## 测试方法

### 基本测试

1. 启用OpenPilot并进入巡航模式
2. 设置`CSLCEnabled`为`1`
3. 设置`CSLCSpeed`为期望的目标速度(m/s)
4. 观察车辆是否自动调整到目标速度

### 进阶测试

1. **不同速度范围测试**：
   - 设置不同的目标速度，观察车辆在不同速度范围内的表现
   - 测试低速(30-50km/h)、中速(50-80km/h)和高速(80-120km/h)

2. **加减速平顺性测试**：
   - 在行驶过程中改变目标速度，观察加减速的平顺性
   - 测试大幅度速度变化(如从90km/h降至60km/h)的表现

3. **实验模式测试**：
   - 设置`ExperimentalMode`为`1`
   - 观察车辆是否能根据当前加速度动态调整目标速度

4. **长时间稳定性测试**：
   - 在恒定目标速度下长时间行驶(30分钟以上)
   - 观察速度控制的稳定性和精确度

## 故障排除

1. **CSLC功能不工作**：
   - 检查`CSLCEnabled`参数是否正确设置
   - 确认车辆巡航控制系统工作正常
   - 检查OpenPilot是否正常接管

2. **速度控制不精确**：
   - 调整`longitudinalTuning`参数
   - 检查`CSLCSpeed`参数是否正确设置
   - 确认单位设置(公制/英制)是否正确

3. **加减速不平顺**：
   - 尝试调整`longitudinalTuning.kpV`和`longitudinalTuning.kiV`参数
   - 在非实验模式下测试

## 注意事项

1. 此功能通过模拟按下巡航控制按钮实现，依赖于车辆原厂巡航系统的可用性。
2. 速度调整精度受限于原厂巡航系统的调速精度(通常为5km/h或5mph的增量)。
3. 在使用此功能时，驾驶员仍需全程监控车辆状态，并随时准备接管控制。
4. 此功能仅在OpenPilot正常工作且巡航控制系统可用的情况下有效。