{% extends "layout.html" %}

{% block title %}
  腾讯地图导航
{% endblock %}

{% block main %}
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
      <title>地点搜索与导航</title>
      <!-- UIkit CSS -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/css/uikit.min.css" />
      <!-- UIkit JS -->
      <script src="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/js/uikit.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/js/uikit-icons.min.js"></script>

      <style type="text/css">
          body {
              margin: 0;
              height: 100%;
              width: 100%;
              position: absolute;
          }

          #mapContainer {
              width: 100%;
              height: 80vh;
              position: relative;
          }

          .search-box {
              position: absolute;
              top: 20px;
              left: 20px;
              right: 20px;
              z-index: 999;
              background: white;
              padding: 10px;
              border-radius: 3px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.2);
          }

          .search-results {
              position: absolute;
              top: 80px;
              left: 20px;
              right: 20px;
              z-index: 998;
              background: white;
              border-radius: 3px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.2);
              max-height: 300px;
              overflow-y: auto;
              display: none;
          }

          .search-result-item {
              padding: 10px;
              border-bottom: 1px solid #eee;
              cursor: pointer;
          }

          .search-result-item:hover {
              background-color: #f5f5f5;
          }
      </style>

      <div class="search-box">
          <div class="uk-grid-small" uk-grid>
              <div class="uk-width-1-4">
                  <select id="save_type" class="uk-select">
                      <option value="recent">最近</option>
                      <option value="home">住家</option>
                      <option value="work">工作</option>
                  </select>
              </div>
              <div class="uk-width-3-4">
                  <div class="uk-inline uk-width-1-1">
                      <span class="uk-form-icon" uk-icon="icon: search"></span>
                      <input class="uk-input" type="text" id="keyword"
                          placeholder="请输入关键字搜索地点"
                          autocomplete="off">
                  </div>
              </div>
          </div>
      </div>

      <div id="search-results" class="search-results"></div>
      <div id="mapContainer"></div>

      <script charset="utf-8" src="https://map.qq.com/api/gljs?v=1.exp&key=BDMBZ-LZQ63-GUG37-OCHES-2ESXV-Q5BVC"></script>
      <script type="text/javascript">
        let map, marker, infoWindow;
        let searchService, suggestionService;
        const initialPosition = new TMap.LatLng({{ lat }}, {{ lon }});

        // 初始化地图
        function initMap() {
            map = new TMap.Map('mapContainer', {
                center: initialPosition,
                zoom: 15,
                showControl: true
            });

            // 初始化搜索服务
            searchService = new TMap.service.Search({
                key: 'BDMBZ-LZQ63-GUG37-OCHES-2ESXV-Q5BVC'
            });

            // 初始化关键词联想服务
            suggestionService = new TMap.service.Suggestion({
                key: 'BDMBZ-LZQ63-GUG37-OCHES-2ESXV-Q5BVC'
            });

            // 添加当前位置标记
            marker = new TMap.MultiMarker({
                map: map,
                styles: {
                    "marker": new TMap.MarkerStyle({
                        width: 25,
                        height: 35,
                        anchor: { x: 12.5, y: 35 },
                        src: 'https://mapapi.qq.com/web/lbs/javascriptGL/demo/img/marker.png'
                    })
                },
                geometries: [{
                    id: 'current',
                    position: initialPosition,
                    styleId: 'marker'
                }]
            });

            // 添加点击事件
            map.on('click', handleMapClick);
        }

        // 处理地图点击
        function handleMapClick(evt) {
            const position = evt.latLng;

            // 更新标记位置
            marker.updateGeometries([{
                id: 'current',
                position: position,
                styleId: 'marker'
            }]);

            // 显示信息窗口
            showInfoWindow(position, `坐标: (${position.lat.toFixed(6)}, ${position.lng.toFixed(6)})`);
        }

        // 显示信息窗口
        function showInfoWindow(position, content) {
            if (infoWindow) {
                infoWindow.close();
            }

            infoWindow = new TMap.InfoWindow({
                map: map,
                position: position,
                content: `
                    <div style="padding:10px;">
                        <p>${content}</p>
                        <form name="navForm" method="post">
                            <input type="hidden" name="lat" value="${position.lat}">
                            <input type="hidden" name="lon" value="${position.lng}">
                            <input type="hidden" name="save_type" value="${document.getElementById('save_type').value}">
                            <input class="uk-button uk-button-primary" type="submit" value="导航">
                        </form>
                    </div>
                `,
                offset: { x: 0, y: -35 }
            });
        }

        // 搜索地点
        let searchTimeout;
        document.getElementById('keyword').addEventListener('input', function() {
            const keyword = this.value.trim();
            clearTimeout(searchTimeout);

            if (keyword) {
                searchTimeout = setTimeout(() => {
                    // 先获取联想词
                    getSuggestions(keyword);
                }, 300);
            } else {
                document.getElementById('search-results').style.display = 'none';
            }
        });

        // 获取联想词
        function getSuggestions(keyword) {
            suggestionService.getSuggestions({
                keyword: keyword,
                location: map.getCenter(),
                region: '全国',
                policy: 1,
                success: function(res) {
                    showSearchResults(res.data);
                },
                error: function() {
                    UIkit.notification({
                        message: '获取联想词失败，请重试',
                        status: 'danger',
                        pos: 'top-center',
                        timeout: 3000
                    });
                }
            });
        }

        // 执行搜索
        function searchPlace(keyword) {
            searchService.search({
                keyword: keyword,
                location: map.getCenter(),
                boundary: 'nearby(${map.getCenter().lat},${map.getCenter().lng},50000)',
                page_size: 10,
                page_index: 1,
                success: function(res) {
                    if (res.data.length > 0) {
                        const result = res.data[0];
                        const position = new TMap.LatLng(result.location.lat, result.location.lng);

                        // 更新地图视图
                        map.setCenter(position);
                        map.setZoom(16);

                        // 更新标记
                        marker.updateGeometries([{
                            id: 'current',
                            position: position,
                            styleId: 'marker'
                        }]);

                        // 显示信息窗口
                        showInfoWindow(position, `
                            <h4>${result.title}</h4>
                            <p>${result.address}</p>
                        `);
                    }
                },
                error: function() {
                    UIkit.notification({
                        message: '搜索失败，请重试',
                        status: 'danger',
                        pos: 'top-center',
                        timeout: 3000
                    });
                }
            });
        }

        // 显示搜索结果
        function showSearchResults(results) {
            const container = document.getElementById('search-results');
            container.innerHTML = '';

            if (results && results.length > 0) {
                results.forEach(result => {
                    const div = document.createElement('div');
                    div.className = 'search-result-item';
                    div.innerHTML = `
                        <div class="uk-text-bold">${result.title}</div>
                        <div class="uk-text-small uk-text-muted">${result.address || ''}</div>
                    `;

                    div.onclick = () => {
                        // 点击联想词时执行搜索
                        searchPlace(result.title);
                        // 隐藏搜索结果
                        container.style.display = 'none';
                        // 更新输入框
                        document.getElementById('keyword').value = result.title;
                    };

                    container.appendChild(div);
                });

                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        // 添加回车搜索功能
        document.getElementById('keyword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const keyword = this.value.trim();
                if (keyword) {
                    searchPlace(keyword);
                    document.getElementById('search-results').style.display = 'none';
                }
            }
        });

        // 点击页面其他地方时隐藏搜索结果
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-box') && !e.target.closest('.search-results')) {
                document.getElementById('search-results').style.display = 'none';
            }
        });

        // 初始化地图
        initMap();
      </script>
{% endblock %}