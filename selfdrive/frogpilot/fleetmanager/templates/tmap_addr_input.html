{% extends "layout.html" %}

{% block title %}
  腾讯地图导航
{% endblock %}

{% block main %}
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
      <title>地点搜索与导航</title>
      <!-- UIkit CSS -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/css/uikit.min.css" />
      <!-- UIkit JS -->
      <script src="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/js/uikit.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/js/uikit-icons.min.js"></script>

      <style type="text/css">
          body {
              margin: 0;
              height: 100%;
              width: 100%;
              position: absolute;
          }

          #mapContainer {
              width: 100%;
              height: 80vh;
              position: relative;
          }

          .search-box {
              position: absolute;
              top: 20px;
              left: 20px;
              right: 20px;
              z-index: 999;
              background: white;
              padding: 10px;
              border-radius: 3px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.2);
          }

          .search-results {
              position: absolute;
              top: 80px;
              left: 20px;
              right: 20px;
              z-index: 998;
              background: white;
              border-radius: 3px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.2);
              max-height: 300px;
              overflow-y: auto;
              display: none;
          }

          .search-result-item {
              padding: 10px;
              border-bottom: 1px solid #eee;
              cursor: pointer;
          }

          .search-result-item:hover {
              background-color: #f5f5f5;
          }
      </style>

      <div class="search-box">
          <div class="uk-grid-small" uk-grid>
              <div class="uk-width-1-4">
                  <select id="save_type" class="uk-select">
                      <option value="recent">最近</option>
                      <option value="home">住家</option>
                      <option value="work">工作</option>
                  </select>
              </div>
              <div class="uk-width-3-4">
                  <div class="uk-inline uk-width-1-1">
                      <span class="uk-form-icon" uk-icon="icon: search"></span>
                      <input class="uk-input" type="text" id="keyword"
                          placeholder="请输入关键字搜索地点"
                          autocomplete="off">
                  </div>
              </div>
          </div>
      </div>

      <div id="search-results" class="search-results"></div>
      <div id="mapContainer"></div>

      <script charset="utf-8" src="https://map.qq.com/api/gljs?v=1.exp&key=BDMBZ-LZQ63-GUG37-OCHES-2ESXV-Q5BVC"></script>
      <script type="text/javascript">
        // 日志函数
        function log(type, message, data) {
            console.log(`[${type}] ${message}`, data);
            const logDiv = document.getElementById('log-container');
            if (logDiv) {
                const logItem = document.createElement('div');
                logItem.className = `uk-alert uk-alert-${type === 'ERROR' ? 'danger' : 'primary'}`;
                logItem.innerHTML = `<pre>[${type}] ${message}\n${JSON.stringify(data, null, 2)}</pre>`;
                logDiv.insertBefore(logItem, logDiv.firstChild);
            }
        }

        // 添加日志容器到页面底部
        const logContainer = document.createElement('div');
        logContainer.id = 'log-container';
        logContainer.style.cssText = 'position:fixed; bottom:0; left:0; right:0; max-height:200px; overflow-y:auto; background:rgba(255,255,255,0.9); z-index:1000; padding:10px;';
        document.body.appendChild(logContainer);

        let map = null;
        let marker = null;
        let infoWindow = null;

        // 初始化地图
        function initMap() {
            try {
                map = new TMap.Map('mapContainer', {
                    center: new TMap.LatLng({{ lat }}, {{ lon }}),
                    zoom: 15,
                    showControl: true
                });
                log('INFO', '地图初始化成功', { center: { lat: {{ lat }}, lon: {{ lon }} } });

                // 添加当前位置标记
                marker = new TMap.MultiMarker({
                    map: map,
                    styles: {
                        "marker": new TMap.MarkerStyle({
                            width: 25,
                            height: 35,
                            anchor: { x: 12.5, y: 35 },
                            src: 'https://mapapi.qq.com/web/lbs/javascriptGL/demo/img/marker.png'
                        })
                    },
                    geometries: [{
                        id: 'current',
                        position: new TMap.LatLng({{ lat }}, {{ lon }}),
                        styleId: 'marker'
                    }]
                });

                // 添加点击事件
                map.on('click', handleMapClick);
            } catch (error) {
                log('ERROR', '地图初始化失败', error);
            }
        }

        // 处理地图点击
        function handleMapClick(evt) {
            try {
                const position = evt.latLng;
                log('INFO', '地图点击', { lat: position.lat, lng: position.lng });

                // 更新标记位置
                marker.updateGeometries([{
                    id: 'current',
                    position: position,
                    styleId: 'marker'
                }]);

                // 显示信息窗口
                showInfoWindow(position, `坐标: (${position.lat.toFixed(6)}, ${position.lng.toFixed(6)})`);
            } catch (error) {
                log('ERROR', '处理地图点击失败', error);
            }
        }

        // 搜索地点
        let searchTimeout;
        document.getElementById('keyword').addEventListener('input', function() {
            const keyword = this.value.trim();
            clearTimeout(searchTimeout);

            if (keyword) {
                searchTimeout = setTimeout(() => {
                    searchByWebService(keyword);
                }, 300);
            } else {
                document.getElementById('search-results').style.display = 'none';
            }
        });

        // 使用WebService API进行搜索
        function searchByWebService(keyword) {
            const center = map.getCenter();
            const url = `https://apis.map.qq.com/ws/place/v1/search?keyword=${encodeURIComponent(keyword)}&boundary=nearby(${center.lat},${center.lng},50000)&key=BDMBZ-LZQ63-GUG37-OCHES-2ESXV-Q5BVC&page_size=10&page_index=1`;

            log('INFO', '发起搜索请求', { keyword, url });

            fetch(url)
                .then(response => response.json())
                .then(result => {
                    log('INFO', '搜索结果', result);
                    if (result.status === 0) {
                        showSearchResults(result.data);
                    } else {
                        throw new Error(result.message);
                    }
                })
                .catch(error => {
                    log('ERROR', '搜索失败', error);
                    UIkit.notification({
                        message: '搜索失败：' + error.message,
                        status: 'danger',
                        pos: 'top-center',
                        timeout: 3000
                    });
                });
        }

        // 显示搜索结果
        function showSearchResults(results) {
            const container = document.getElementById('search-results');
            container.innerHTML = '';

            if (results && results.length > 0) {
                results.forEach(result => {
                    const div = document.createElement('div');
                    div.className = 'search-result-item';
                    div.innerHTML = `
                        <div class="uk-text-bold">${result.title}</div>
                        <div class="uk-text-small uk-text-muted">${result.address}</div>
                    `;

                    div.onclick = () => {
                        try {
                            const position = new TMap.LatLng(result.location.lat, result.location.lng);

                            // 更新地图视图
                            map.setCenter(position);
                            map.setZoom(16);

                            // 更新标记
                            marker.updateGeometries([{
                                id: 'current',
                                position: position,
                                styleId: 'marker'
                            }]);

                            // 显示信息窗口
                            showInfoWindow(position, `
                                <h4>${result.title}</h4>
                                <p>${result.address}</p>
                            `);

                            // 隐藏搜索结果
                            container.style.display = 'none';
                            // 更新输入框
                            document.getElementById('keyword').value = result.title;

                            log('INFO', '选择搜索结果', result);
                        } catch (error) {
                            log('ERROR', '处理搜索结果失败', error);
                        }
                    };

                    container.appendChild(div);
                });

                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        // 显示信息窗口
        function showInfoWindow(position, content) {
            try {
                if (infoWindow) {
                    infoWindow.close();
                }

                infoWindow = new TMap.InfoWindow({
                    map: map,
                    position: position,
                    content: `
                        <div style="padding:10px;">
                            ${content}
                            <form name="navForm" method="post">
                                <input type="hidden" name="lat" value="${position.lat}">
                                <input type="hidden" name="lon" value="${position.lng}">
                                <input type="hidden" name="save_type" value="${document.getElementById('save_type').value}">
                                <input class="uk-button uk-button-primary" type="submit" value="导航">
                            </form>
                        </div>
                    `,
                    offset: { x: 0, y: -35 }
                });
            } catch (error) {
                log('ERROR', '显示信息窗口失败', error);
            }
        }

        // 添加回车搜索功能
        document.getElementById('keyword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const keyword = this.value.trim();
                if (keyword) {
                    searchByWebService(keyword);
                    document.getElementById('search-results').style.display = 'none';
                }
            }
        });

        // 点击页面其他地方时隐藏搜索结果
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-box') && !e.target.closest('.search-results')) {
                document.getElementById('search-results').style.display = 'none';
            }
        });

        // 初始化地图
        initMap();
      </script>
{% endblock %}