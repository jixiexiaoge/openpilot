{% extends "layout.html" %}

{% block title %}
  腾讯地图导航
{% endblock %}

{% block main %}
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
      <title>地点搜索与导航</title>
      <!-- UIkit CSS -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/css/uikit.min.css" />
      <!-- UIkit JS -->
      <script src="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/js/uikit.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/uikit@3.9.2/dist/js/uikit-icons.min.js"></script>
      <!-- 腾讯地图API -->
      <script charset="utf-8" src="https://map.qq.com/api/js?v=2.exp&key=BDMBZ-LZQ63-GUG37-OCHES-2ESXV-Q5BVC"></script>

      <style type="text/css">
          body {
              margin: 0;
              height: 100%;
              width: 100%;
              position: absolute;
          }

          #mapContainer {
              width: 100%;
              height: 80vh;
              position: relative;
          }

          .search-box {
              position: absolute;
              top: 20px;
              left: 20px;
              right: 20px;
              z-index: 999;
              background: white;
              padding: 10px;
              border-radius: 3px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.2);
          }

          .search-results {
              position: absolute;
              top: 80px;
              left: 20px;
              right: 20px;
              z-index: 998;
              background: white;
              border-radius: 3px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.2);
              max-height: 300px;
              overflow-y: auto;
              display: none;
          }

          .search-result-item {
              padding: 10px;
              border-bottom: 1px solid #eee;
              cursor: pointer;
          }

          .search-result-item:hover {
              background-color: #f5f5f5;
          }
      </style>

      <div class="search-box">
          <div class="uk-grid-small" uk-grid>
              <div class="uk-width-1-4">
                  <select id="save_type" class="uk-select">
                      <option value="recent">最近</option>
                      <option value="home">住家</option>
                      <option value="work">工作</option>
                  </select>
              </div>
              <div class="uk-width-3-4">
                  <div class="uk-inline uk-width-1-1">
                      <span class="uk-form-icon" uk-icon="icon: search"></span>
                      <input class="uk-input" type="text" id="keyword"
                          placeholder="请输入关键字搜索地点"
                          autocomplete="off">
                  </div>
              </div>
          </div>
      </div>

      <div id="search-results" class="search-results"></div>
      <div id="mapContainer"></div>

      <script type="text/javascript">
        // 配置
        const KEY = 'BDMBZ-LZQ63-GUG37-OCHES-2ESXV-Q5BVC';
        let map = null;
        let marker = null;
        let infoWindow = null;
        let searchService = null;
        let geocoder = null;

        // 初始化坐标（南京市中心坐标）
        const defaultLat = 32.059344;
        const defaultLng = 118.796615;
        const initLat = {{ lat }} || defaultLat;
        const initLng = {{ lon }} || defaultLng;

        // 日志函数
        function log(type, message, data) {
            console.log(`[${type}] ${message}`, data);
            const logDiv = document.getElementById('log-container');
            if (logDiv) {
                const logItem = document.createElement('div');
                logItem.className = `uk-alert uk-alert-${type === 'ERROR' ? 'danger' : 'primary'}`;
                logItem.innerHTML = `<pre>[${type}] ${message}\n${JSON.stringify(data, null, 2)}</pre>`;
                logDiv.insertBefore(logItem, logDiv.firstChild);
            }
        }

        // 添加日志容器
        const logContainer = document.createElement('div');
        logContainer.id = 'log-container';
        logContainer.style.cssText = 'position:fixed; bottom:0; left:0; right:0; max-height:200px; overflow-y:auto; background:rgba(255,255,255,0.9); z-index:1000; padding:10px;';
        document.body.appendChild(logContainer);

        // 初始化地图
        function initMap() {
            try {
                // 等待地图API加载完成
                if (typeof qq === 'undefined' || typeof qq.maps === 'undefined') {
                    log('ERROR', '地图API未加载', null);
                    setTimeout(initMap, 100);
                    return;
                }

                const center = new qq.maps.LatLng(initLat, initLng);

                // 初始化地图
                map = new qq.maps.Map(document.getElementById('mapContainer'), {
                    center: center,
                    zoom: 13,
                    mapTypeId: qq.maps.MapTypeId.ROADMAP
                });

                // 初始化搜索服务
                searchService = new qq.maps.SearchService({
                    location: center.lat + ',' + center.lng,
                    complete: function(results) {
                        if (results.detail.pois && results.detail.pois.length > 0) {
                            showSearchResults(results.detail.pois);
                        } else {
                            UIkit.notification({
                                message: '未找到相关地点',
                                status: 'warning',
                                pos: 'top-center',
                                timeout: 3000
                            });
                        }
                    },
                    error: function(error) {
                        log('ERROR', '搜索服务错误', error);
                        UIkit.notification({
                            message: '搜索失败，请重试',
                            status: 'danger',
                            pos: 'top-center',
                            timeout: 3000
                        });
                    }
                });

                // 初始化地理编码服务
                geocoder = new qq.maps.Geocoder({
                    complete: function(result) {
                        if (result.detail.address) {
                            const address = result.detail.address;
                            const position = result.detail.location;
                            showInfoWindow(position, `
                                <h4>${address}</h4>
                                <p>坐标: (${position.lat.toFixed(6)}, ${position.lng.toFixed(6)})</p>
                            `);
                        }
                    }
                });

                log('INFO', '地图初始化成功', { lat: initLat, lng: initLng });

                // 添加当前位置标记
                marker = new qq.maps.Marker({
                    map: map,
                    position: center
                });

                // 添加点击事件
                qq.maps.event.addListener(map, 'click', handleMapClick);

                // 添加缩放控件
                map.setOptions({
                    panControl: true,
                    zoomControl: true,
                    mapTypeControl: true,
                    scaleControl: true
                });

            } catch (error) {
                log('ERROR', '地图初始化失败', error);
            }
        }

        // 处理地图点击
        function handleMapClick(evt) {
            try {
                const position = evt.latLng;
                log('INFO', '地图点击', { lat: position.lat, lng: position.lng });

                // 更新标记位置
                marker.setPosition(position);

                // 获取地址信息
                geocoder.getAddress(position);
            } catch (error) {
                log('ERROR', '处理地图点击失败', error);
            }
        }

        // 使用搜索服务
        function searchByService(keyword) {
            try {
                if (!searchService) {
                    throw new Error('搜索服务未初始化');
                }

                const center = map.getCenter();
                log('INFO', '发起搜索请求', {
                    keyword,
                    center: { lat: center.lat, lng: center.lng }
                });

                // 设置搜索范围为当前地图中心点50公里范围内
                searchService.setLocation(center.lat + ',' + center.lng);
                searchService.setPageIndex(1);
                searchService.setPageCapacity(20);
                searchService.searchNearBy(keyword, center, 50000);  // 50公里范围内

            } catch (error) {
                log('ERROR', '搜索失败', error);
                UIkit.notification({
                    message: '搜索失败：' + error.message,
                    status: 'danger',
                    pos: 'top-center',
                    timeout: 3000
                });
            }
        }

        // 显示搜索结果
        function showSearchResults(pois) {
            const container = document.getElementById('search-results');
            container.innerHTML = '';

            if (pois && pois.length > 0) {
                pois.forEach(poi => {
                    const div = document.createElement('div');
                    div.className = 'search-result-item';
                    div.innerHTML = `
                        <div class="uk-text-bold">${poi.name}</div>
                        <div class="uk-text-small uk-text-muted">${poi.address}</div>
                        <div class="uk-text-small uk-text-muted">距离: ${(poi.distance || 0).toFixed(1)}米</div>
                    `;

                    div.onclick = () => {
                        try {
                            const position = poi.latLng;

                            // 更新地图视图
                            map.setCenter(position);
                            map.setZoom(16);

                            // 更新标记
                            marker.setPosition(position);

                            // 显示信息窗口
                            showInfoWindow(position, `
                                <h4>${poi.name}</h4>
                                <p>${poi.address}</p>
                                <p>距离: ${(poi.distance || 0).toFixed(1)}米</p>
                            `);

                            // 隐藏搜索结果
                            container.style.display = 'none';
                            // 更新输入框
                            document.getElementById('keyword').value = poi.name;

                            log('INFO', '选择搜索结果', poi);
                        } catch (error) {
                            log('ERROR', '处理搜索结果失败', error);
                        }
                    };

                    container.appendChild(div);
                });

                container.style.display = 'block';
            } else {
                container.style.display = 'none';
                UIkit.notification({
                    message: '未找到相关地点',
                    status: 'warning',
                    pos: 'top-center',
                    timeout: 3000
                });
            }
        }

        // 显示信息窗口
        function showInfoWindow(position, content) {
            try {
                if (infoWindow) {
                    infoWindow.close();
                }

                infoWindow = new qq.maps.InfoWindow({
                    map: map,
                    position: position,
                    content: `
                        <div style="padding:10px;">
                            ${content}
                            <form name="navForm" method="post">
                                <input type="hidden" name="lat" value="${position.lat}">
                                <input type="hidden" name="lon" value="${position.lng}">
                                <input type="hidden" name="save_type" value="${document.getElementById('save_type').value}">
                                <input class="uk-button uk-button-primary" type="submit" value="导航">
                            </form>
                        </div>
                    `
                });
            } catch (error) {
                log('ERROR', '显示信息窗口失败', error);
            }
        }

        // 搜索防抖
        let searchTimeout;
        document.getElementById('keyword').addEventListener('input', function() {
            const keyword = this.value.trim();
            clearTimeout(searchTimeout);

            if (keyword) {
                searchTimeout = setTimeout(() => {
                    searchByService(keyword);
                }, 500);  // 增加延迟到500ms
            } else {
                document.getElementById('search-results').style.display = 'none';
            }
        });

        // 添加回车搜索功能
        document.getElementById('keyword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const keyword = this.value.trim();
                if (keyword) {
                    searchByService(keyword);
                    document.getElementById('search-results').style.display = 'none';
                }
            }
        });

        // 点击页面其他地方时隐藏搜索结果
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-box') && !e.target.closest('.search-results')) {
                document.getElementById('search-results').style.display = 'none';
            }
        });

        // 等待页面加载完成后初始化地图
        window.addEventListener('load', function() {
            setTimeout(initMap, 500);
        });
      </script>
{% endblock %}