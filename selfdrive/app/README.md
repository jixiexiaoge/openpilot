# CommaAssist - Comma3数据广播与监控工具

这个文件夹包含用于获取Comma3数据并在局域网中广播的实用工具，以及接收和显示这些数据的客户端工具。

## 工具列表

1. **commassit.py** - 运行在Comma3设备上的数据广播服务
   - 获取设备状态、车辆状态、位置信息和导航数据
   - 包含全面的车辆详细信息（车轮速度、安全系统、灯光状态等）
   - 以JSON格式通过UDP广播到局域网
   - 支持错误处理和网络异常恢复

2. **commalisten.py** - 终端界面的数据监控工具
   - 使用curses库提供交互式终端UI
   - 显示设备、车辆、位置和导航完整信息
   - 支持彩色显示和实时更新

3. **commawebview.py** - 基于Web的监控界面
   - 使用Flask框架提供网页访问
   - 响应式设计，支持手机和电脑访问
   - 提供车辆/设备/位置/导航分类标签页显示
   - 显示全面的车辆详细信息（安全系统、车轮速度、盲点监测等）
   - 根据车辆启动状态自动切换显示内容
   - 支持地图显示功能（需配置API密钥）

## 安装依赖

对于服务端(Comma3设备)，所有依赖已预先安装，无需额外操作。

对于客户端(接收端)，需要安装以下依赖：

```bash
# 终端界面所需依赖
pip install curses

# Web界面所需依赖
pip install flask
```

## 使用方法

### 服务端 (Comma3设备)

在Comma3设备上启动服务：

```bash
cd /data/openpilot
python selfdrive/app/commassit.py
```

这将启动广播服务，默认在端口8088上广播数据。服务会自动检测网络状态，并选择合适的广播地址。

### 客户端 (接收端)

#### 终端界面监控

在任何支持Python的设备上运行：

```bash
# 默认端口8088
python selfdrive/app/commalisten.py

# 指定不同端口
python selfdrive/app/commalisten.py -p 8088
```

使用终端界面时可通过键盘交互：
- `q` - 退出程序

#### Web界面监控

```bash
# 默认配置 (UDP端口8088, Web端口5000)
python selfdrive/app/commawebview.py

# 自定义配置
python selfdrive/app/commawebview.py -p 8088 -w 5000 --host 0.0.0.0
```

然后在浏览器中访问 `http://<你的IP>:5000` 查看Web监控界面。

Web界面特性：
- 根据车辆启动状态自动切换显示内容
- 支持标签页切换查看不同类别信息
- 支持自动刷新和手动刷新
- 提供地图显示位置功能

**注意**：如果要使用地图功能，需要在commawebview.py中替换Google Maps API密钥。

## 广播的数据内容

广播数据以JSON格式发送，主要包含以下信息：

### 设备信息
- IP地址
- 电池状态（电量、电压、电流）
- 内存使用率
- CPU温度
- 存储空间剩余

### 车辆信息
- 车速和档位状态
- 巡航速度设定
- 方向盘角度和力矩
- 制动和油门踏板状态
- 车门开关状态
- 转向灯状态

### 扩展车辆信息
- 车型和车辆指纹信息
- 车辆基本参数（重量、轴距、转向比）
- 车轮速度（四轮单独数据）
- 巡航系统详细状态（启用、可用、设定速度、跟车距离）
- 安全系统状态（ESP、ABS、TCS、碰撞警告）
- 车门状态（驾驶员门、乘客门、行李箱、引擎盖）
- 灯光状态（转向灯、远光灯、近光灯）
- 盲点监测信息
- 其他信息（车外温度、燃油续航、里程表、油耗）

### GPS位置
- 经纬度坐标
- 方向角度
- 海拔高度
- 定位精度
- GPS速度

### 导航信息
- 目的地距离
- 预计到达时间
- 道路速度限制
- 下一个导航动作信息
- 动作距离

## 自定义和扩展

您可以根据需要修改这些脚本，添加额外的数据字段或更改显示方式：

- 在commassit.py中的`make_data_message`函数修改广播的数据内容
- 在客户端脚本中更新相应的显示逻辑
- 修改Web界面模板以添加新的显示部分

## 故障排除

常见问题及解决方法：

1. 广播服务无法启动
   - 检查网络权限和接口状态
   - 尝试以root权限运行服务

2. 客户端无法接收数据
   - 检查防火墙是否允许UDP端口8088
   - 确认客户端和服务端在同一局域网

3. 地图不显示
   - 需要有效的Google Maps API密钥
   - 检查网络连接状态

4. 车辆数据不完整
   - 某些字段在不同车型间可能不存在
   - 服务会安全地处理不存在的字段，只显示可用数据