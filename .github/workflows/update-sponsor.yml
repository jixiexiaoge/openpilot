name: ğŸ•·ï¸ Update Sponsor Rank

on:
  schedule:
    - cron: "0 10 * * *"   # æ¯å¤© UTC 10 ç‚¹è¿è¡Œ
  workflow_dispatch:         # å¯æ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Run sponsor update inline
        shell: bash
        run: |
          set -e
          echo "ğŸ•·ï¸ Running sponsor update script..."

          URL="http://31.97.51.107:8500/"
          README="README.md"
          MIN_AMOUNT=60

          # ä¸´æ—¶ Python è„šæœ¬
          python3 <<'PYCODE'
import requests, re, datetime, json, os, urllib3
from bs4 import BeautifulSoup

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
URL = "http://31.97.51.107:8500/"
README = "README.md"
MIN_AMOUNT = 60

def extract_number(s):
    if not s: return None
    s = s.replace(',', '')
    m = re.search(r'(\d+(?:\.\d+)?)', s)
    return float(m.group(1)) if m else None

def fetch():
    try:
        r = requests.get(URL, timeout=20, verify=False)
        r.raise_for_status()
    except Exception as e:
        print(f"âš ï¸ è¯·æ±‚å¤±è´¥: {e}")
        return []
    soup = BeautifulSoup(r.text, "html.parser")
    items = []

    # 1. ç»“æ„åŒ–æŠ“å–
    for item in soup.select(".sponsor-item"):
        name = item.select_one(".username, .name, h3")
        amt = item.select_one(".amount, .money, .price")
        if name and amt:
            val = extract_number(amt.text)
            if val and val > MIN_AMOUNT:
                items.append({"username": name.text.strip(), "amount": val})

    # 2. è¡¨æ ¼æŠ“å–
    if not items:
        for tr in soup.select("table tr"):
            cols = [td.get_text(strip=True) for td in tr.select("td,th")]
            if len(cols) >= 2:
                name, amt = cols[0], extract_number(cols[-1])
                if amt and amt > MIN_AMOUNT:
                    items.append({"username": name, "amount": amt})

    # 3. æ–‡æœ¬åŒ¹é…
    if not items:
        text = soup.get_text(separator="\n")
        for line in text.splitlines():
            if re.search(r"\d", line):
                val = extract_number(line)
                if val and val > MIN_AMOUNT:
                    name = re.sub(r"[\dï¿¥$Â¥,.]+$", "", line.strip())[:60]
                    items.append({"username": name or "unknown", "amount": val})

    # å»é‡æ’åº
    dedup = {}
    for x in items:
        if x["username"] not in dedup or x["amount"] > dedup[x["username"]]:
            dedup[x["username"]] = x["amount"]
    res = [{"username": k, "amount": v} for k, v in dedup.items()]
    res.sort(key=lambda x: x["amount"], reverse=True)
    print(json.dumps(res, ensure_ascii=False, indent=2))
    return res

def update_readme(sponsors):
    if not os.path.exists(README): return
    with open(README, "r", encoding="utf-8") as f:
        lines = f.readlines()
    while len(lines) < 87: lines.append("\n")
    prefix = "".join(lines[:87])

    ts = datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")
    if not sponsors:
        content = "_æš‚æ— æ•°æ®_"
    else:
        content = "\n".join([f"- **{s['username']}** â€” ğŸ’° {int(s['amount']) if s['amount'].is_integer() else s['amount']}" for s in sponsors])
    new_md = f"""
---

### ğŸ† èµåŠ©æ’è¡Œæ¦œï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰

> æ•°æ®æ¥æºï¼š[{URL}]({URL})  
> æ›´æ–°æ—¶é—´ï¼š{ts}

{content}

ï¼ˆæœ¬æ®µå†…å®¹ç”± GitHub Actions è‡ªåŠ¨æ›´æ–°ï¼‰
"""
    with open(README, "w", encoding="utf-8") as f:
        f.write(prefix + new_md)
    print("âœ… README.md å·²æ›´æ–°ã€‚")

if __name__ == "__main__":
    data = fetch()
    update_readme(data)
PYCODE

      - name: Commit and push changes
        shell: bash
        run: |
          set +e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if git diff --quiet; then
            echo "âœ… No changes detected."
          else
            git add README.md
            git commit -m "ğŸ”„ Update sponsor list"
            git push
            echo "âœ… Changes pushed."
          fi
