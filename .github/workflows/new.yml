name: ğŸ•·ï¸ Update Sponsor List

on:
  schedule:
    - cron: '0 10 * * *'   # æ¯å¤© UTC 10 ç‚¹
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm init -y
          npm i playwright

      - name: Run Playwright script and update README
        run: |
          node <<'JS'
const { chromium } = require('playwright');
const fs = require('fs');

(async () => {
  const browser = await chromium.launch();
  const page = await browser.newPage();
  await page.goto('http://31.97.51.107:8500/', { waitUntil: 'networkidle' });

  // æå–æ’è¡Œæ¦œ
  const sponsors = await page.$$eval('.sponsor-item', items =>
    items.map(i => ({
      username: i.querySelector('.username')?.innerText || 'unknown',
      amount: parseFloat((i.querySelector('.amount')?.innerText || '0').replace(/[^\d.]/g,''))
    })).filter(x => x.amount > 60)
  );

  await browser.close();

  console.log("æŠ“å–ç»“æœ:", JSON.stringify(sponsors, null, 2));

  // æ›´æ–° README.md
  const README_FILE = 'README.md';
  if (!fs.existsSync(README_FILE)) return;

  const readmeLines = fs.readFileSync(README_FILE, 'utf-8').split('\n');

  // ä¿ç•™å‰ 87 è¡Œ
  while (readmeLines.length < 87) readmeLines.push('');
  const prefix = readmeLines.slice(0,87).join('\n');

  const ts = new Date().toISOString().replace('T',' ').split('.')[0] + ' UTC';
  let content = sponsors.map(s => `- **${s.username}** â€” ğŸ’° ${s.amount}`).join('\n');
  if (!content) content = "_æš‚æ— æ•°æ®_";

  const newMarkdown = `${prefix}

---

### ğŸ† èµåŠ©æ’è¡Œæ¦œï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰

> æ•°æ®æ¥æºï¼š[http://31.97.51.107:8500/](http://31.97.51.107:8500/)  
> æ›´æ–°æ—¶é—´ï¼š${ts}

${content}

ï¼ˆæœ¬æ®µå†…å®¹ç”± GitHub Actions è‡ªåŠ¨æ›´æ–°ï¼‰
`;

  fs.writeFileSync(README_FILE, newMarkdown);
})();
JS

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          if git diff --cached --quiet; then
            echo "âœ… No changes detected."
          else
            git commit -m "ğŸ”„ Update sponsor list"
            git push
            echo "âœ… Changes pushed."
          fi
